name: Front - Build & Deploy (Local Docker)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH (local Docker build)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e

            cd /opt/webapps/apps/portafolio-2026

            echo "Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            git pull origin main

            echo "Building containers..."
            docker compose -f docker-compose.prod.yml build

            echo "Restarting containers..."
            docker compose -f docker-compose.prod.yml up -d

            echo "Cleaning unused images..."
            docker image prune -f

  notify:
    name: Discord notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Send Discord webhook
        env:
          WEBHOOK: ${{ secrets.DISCORD_DEPLOY_WEBHOOK }}
          RESULT: ${{ needs.deploy.result }}
          VERSION: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # Skip if no webhook configured
          if [ -z "$WEBHOOK" ]; then
            echo "Discord webhook not configured, skipping notification"
            exit 0
          fi

          RELEASE_URL="https://github.com/${REPO}/releases/tag/${VERSION}"
          RUN_URL="https://github.com/${REPO}/actions/runs/${RUN_ID}"

          if [ "$RESULT" = "success" ]; then
            COLOR=3066993   # green
            STATUS="✅ Release successful"
            DESC="All platforms built and uploaded"
          else
            COLOR=15158332  # red
            STATUS="❌ Release failed"
            DESC="One or more builds failed"
          fi

          jq -n \
            --arg title "$STATUS" \
            --arg desc "$DESC" \
            --arg version "$VERSION" \
            --arg release "$RELEASE_URL" \
            --arg run "$RUN_URL" \
            --argjson color $COLOR \
            '{
              embeds: [{
                title: $title,
                description: $desc,
                color: $color,
                fields: [
                  {name: "Version", value: $version, inline: true},
                  {name: "Release", value: $release, inline: false},
                  {name: "CI Run", value: $run, inline: false}
                ]
              }]
            }' \
          | curl -H "Content-Type: application/json" -d @- "$WEBHOOK"
